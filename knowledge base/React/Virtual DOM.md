### Что это

Virtual DOM - объектная модель документа, который используется во фреймворках.

Нужен для:
1. Для снижения количества затратных манипуляций с DOM-деревом документа.
2. Эта абстракция избавляет программиста от реальных манипуляций с DOM-деревом.

### Механизм работы

Рассмотрим механизм работы с начальной загрузки документа поэтапно.

###### 1. Compile

Некоторые фреймворки (Vue.js, например) должны сначала скомпилировать Шаблон документа в render-функции. Для React это не нужно.

###### 2. Mount

1. Runtime renderer запускает отработку всех рендер-функций рекурсивно. 
2. Эти функции возвращают объекты, из которых строится Virtual DOM. 
3. Из этого дерева строится реальный DOM и монтируется в документ.

###### 3. Reconciliation

Когда изменяется какая-то зависимость, то происходит реконсилиация:

1. Cоздается новый Virtual DOM.
2. Runtime renderer проходит по этому дереву и сравнивает узлы с текущим деревом.
3. Текущее дерево обновляется в соответствии с результатами сравнения

Чтобы сократить время при обновлении, в React используется не строгая, а эвристическая функция, которая основана не утверждениях:
1. Aлгоритм не будет пытаться сравнивать два элемента разных тегов, а сразу заменит элемент.
2. Ключи должны быть стабильными и уникальными в пределах списка элементов. Нестабильные ключи типа Math.random() вызовут замещение всего списка.

### Алгоритм согласования

1. Сравниваются теги (типы) корневых элементов. Если типы разные - React уничтожает старое дерево строит новое с нуля.
2. Если типы одинаковые, то сравниваются атрибуты и пропсы обоих. Если какой-то атрибут изменился, то обновляется только этот атрибут с сохранением состояния элемента. Полного замещения не будет. Далее идет обход по дочерним элементам.
3. При обходе по дочерним элементам сравнение происходит между элементами с совпадающими ключами. Если не задавать ключи, то весь список будет замещаться.
4. Ключом может быть и индекс элемента но только в том случае, если элементы не меняют порядок.

### Приоритезация DOM-операций

Обновление данных разбивается на маленькие операции, которые называются юниты. Каждому юниту присваивается приоритет, а юниты сортируются в порядке приоритета по убыванию. 

Например, hover-анимация является более приоритетной, чем обновление данных в блоке, которые даже не во viewport.

Приоритет операций определяется с помощью пакета Scheduler. 

Подробнее о приоритезации надо читать в [Fibers](obsidian://open?vault=Obsidian%20Vault&file=knowledge%20base%2FReact%2FReact%20Fibers). 



https://evilmartians.com/chronicles/optimizing-react-virtual-dom-explained