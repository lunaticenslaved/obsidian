## Фаза 1 - Рендер

На этой фазе мы работаем с двумя версиями деревьев Fiber — `current` и `workInProgress`. У каждого Fiber одновременно может быть не больше двух его версий — `current` и `workInProgress`. Получить альтернативную версию можно с помощью свойства `alternate`.

В первом рендере у нас `current === null`, поэтому работа будет вестись только с `workInProgress`. При ререндере уже можно сравнивать `current` c новым `workInProgress`. Во время рендера также выполняются некоторые сайд-эффекты, которые должны быть выполнены до обновления DOM.

### 1. `workLoopSync()` и `workLoopConcurrent()`

В самом начале рендеринга вызывается `workLoopSync()` для запуска рабочего цикла для корневого элемента. После работы над собой, корневой элемент переходит к дочерним элементам до тех пор, пока есть хотя бы один.

Если используется асинхронный рендеринг, который пока не является стабильным API, то будет вызываться `workLoopConcurrent()` для запуска рабочего цикла

### 2. `performUnitOfWork()`

Для каждого элемента в рабочем цикле рендера вызывается функция `performUnitOfWork()` — она получает `Fiber` или `null` (если это первый рендер) и передаёт в функцию `beginWork()`, передавая альтернативную версию `Fiber`, которая далее используется как `workInProgress()`. Последний в односвязном списке `Fiber` после выполнения функции `performUnitOfWork()` вызывает для себя функцию `completeUnitOfWork()`.

### 3. `beginWork()`

Основным предназначением функции `beginWork()` является создание `Fiber` из элемента. В зависимости от значения свойства `tag` у элемента выполняется особенная работа, предназначенная для определённого вида компонента. Во время выполнения `beginWork()` `pendingProps` сравниваются с `memoizedProps`, а `workInProgress` очищается и готовится к стадии `completeWork`.

### 4. `completeUnitOfWork()`

Функция `completeUnitOfWork()` вызывается для последнего `Fiber` после выполнения функции `performUnitOfWork()` и начинает подниматься обратно к самому первому `Fiber`, попутно выполняя для каждого `Fiber` функцию `completeWork()`.

### 5. `completeWork()`

Во время выполнения `completeWork()` `workInProgress` `Fiber` получает `pendingProps` как новые пропсы и завершает построение нового `Fiber` дерева, попутно выполняя завершающие рендеринг операции в зависимости от `Fiber tag`. Это настолько гибко, что добавить свой особый компонент в React со своим поведением можно буквально в 50–100 строчек, добавив `Symbol` для него и описав его поведение в `beginWork()` и `completeWork()`.

![[Pasted image 20230813233837.png]]

## Фаза 2 - Коммит
---

На этой фазе уже есть 2 Fiber дерева — текущее и новое.

Основным предназначением фазы является замена текущего дерева на новое или создание текущего из нового, если это первый рендер.

Для каждого `Fiber` выполняется функция `commitWork()`, которая в основном делает следующее:

- Выполняет сайд-эффекты до обновления дерева элементов.
- Обновляет дерево элементов (для браузера это DOM).
- Выполняет сайд-эффекты после обновления дерева.