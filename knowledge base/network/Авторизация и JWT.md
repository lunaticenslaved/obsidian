### Через токен

**JWT состоит** из: [заголовок] . [тело] . [подпись]

- заголовок - содержит алгоритм шифрования (обязательно) и тип токена (необязательно) и др. (необязательно)
- тело - вшивается самостоятельно. Например, информация о пользователе: id, role, username и т.д. Они не должны быть важными (пароли и т.д.), т.к. легко раскодируются.
- подпись - на сервере берется заголовок и данные и кодируются с помощью секретного ключа, который знает только сервер. Эта подпись нужна только для того, чтобы сервер знал, что токен не был подделан.


**Типы токенов**

- **access token** - основной токен, через которые происходит аутентификация на сервисе. Его хранят в браузере в localStorage или куках. Он имеет срок жизни 15-30 минут или больше. Допустим, срок жизни access token 15 минут. Если мошенник украдет его, то сервисом он может пользоваться максимум 15 минут.
- **refresh token** - с его помощью обновляют access token. Его сервер записывает в httpOnly cookie. Тогда получается, что через JS этот токен было невозможно изменить и этот токен может устанавливать только сервер. Refresh Token записывается в базу и получается как бы сессия. Туда можно записывать IP-адрес с которого был запрос. Если это был новый IP-адрес, то можно пользователю отправить сообщение, что кто-то зашел с нового устройства. Он живет 15-60 дней или больше. То есть если юзер не заходил более этого срока, то токен умрет и пользователю придется логиниться заново. Если токен жив, то сервис автоматически сделает рефреш.

_Сроки жизни токенов зависят от важности сервиса: чем важнее, тем короче._


**Как используются токены:**

На каждый запрос в заголовок Authorization записываем access token. Перед каждой обработкой запросы сервер проверяет валидность токена, если всё ок - запрос обрабатывается, если нет - клиенту возвращается 401 код - ошибка аутентификации. На клиенте происходит обработка 401 ошибки перехватчиком (интерцептором) и сразу отправляется запрос на refresh и (cookie: refreshToken). Сервер сверяет refreshToken с тем, который лежит в БД и, если токен верный и не протух, возвращает новую пару токенов.

  

**Хранение паролей в БД**

_В БД должен храниться хэшированный или зашифрованный пароль._ 

- Шифрование осуществляется по ключу, который знает только сервер. Однако, если слита база паролей, то ключ подобрать вполне реально.
- Хэширование осуществляется через хэш-функцию. На выходе получается строка, которую разхэшировать невозможно. Сравниваются пароли тоже после хэша.